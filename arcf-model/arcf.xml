<?xml version='1.0' encoding='utf-8'?>

<scene version="0.5.0">

    <!--

        Notes on integrators
        ====================

        Unusable:

        - "ao" is not usable.
        - "direct" cannot be used because our light path will contain indirect paths
          (if only because of the detector aperture plane).
        - "path" cannot be used, because our scene contains an opacity mask (for the aperture texture).
          See remark in documentation, Section 8.10, "Choosing an integrator",
          point #1, last sentence.
          In radiance config, it does not honor the aperture mask.
        - "volpath_simple" : does not render the "irradiance" and "irradiance" configurations correctly.
        - "volpath" : does not render the "irradiance" and "radiance" configurations correctly.
        - "photonmapper" : does not render the "irradiance" configuration correctly.
        - "ppm" : does not render the "irradiance" configuration correctly.
                  Radiance shows some data, but looks bad.
                  Note that we need to decrease the sample count to approx. 2 to 4, in the sensor's sampler.
        - "sppm" : does not render the "irradiance" configuration correctly.
                  Radiance shows some data, in the right aperture shape. But quite bad.
                  Note that this ignores the sample count as specified in the sensor's sampler.

        Usable:
        - "path" appears qualitatively to work for the radiance configuration.
        - "bdpt" : renders the "irradiance" scene correctly.
            The "radiance" scene looks qualitatively correct (without the field limiter).
            Once the field limiter is in place, it doesn't work anymore.
        - "pssmlt": works only if we set 'directSamples' to -1 (irradiance)
                radiance works irrespective of directSamples. The value is way off, however.
        - "mlt": works if we disable directSamples, lensPerturbation, multiChainPerturbation, causticPerturbation.
                  and DISABLE manifoldPerturbation (the default).
                  In "radiance" configuration, we can enable manifoldPerturbation, but then it doesn't honor the aperture mask.
        - "erpt": works if we disable directSamples, lensPerturbation, multiChainPerturbation, causticPerturbation,
                  but ENABLE manifoldPerturbation.
                  It sort-of-works in radiance, but we get an incorrect value.
        - "ptracer" works only if we enable "bruteForce", when rendering the "irradiance" configuration.
                 the "radiance" configuration can be rendered with either setting.
    -->

    <!-- The "bdpt" integrator, without any options, works fine the irradiance measurement -->
    <!-- The "path" integrator, without any options, works fine the radiance measurement -->
    <integrator type="bdpt">
    </integrator>

    <!--
    <integrator type="bdpt">
    </integrator>
    -->

    <!--
    <integrator type="photonmapper">
    </integrator>
    -->

    <!--
    <integrator type="pssmlt">
        <integer name="directSamples" value="-1"/>
    </integrator>
    -->

    <!--
    <integrator type="mlt">
        <integer name="directSamples" value="-1"/>
        <boolean name="lensPerturbation" value="false"/>
        <boolean name="multiChainPerturbation" value="false"/>
        <boolean name="causticPerturbation" value="false"/>
        <boolean name="manifoldPerturbation" value="false"/>
    </integrator>
    -->

    <!--
    <integrator type="erpt">
        <integer name="directSamples" value="-1"/>
        <boolean name="lensPerturbation" value="false"/>
        <boolean name="multiChainPerturbation" value="false"/>
        <boolean name="causticPerturbation" value="false"/>
        <boolean name="manifoldPerturbation" value="true"/>
    </integrator>
    -->

    <!--
    <integrator type="ptracer">
        <boolean name="bruteForce" value="false"/>
    </integrator>
    -->

    <!-- select models -->

    <default name="sample-model"        value="spectralon" />  <!-- "spectralon", qvd", or "none" -->
    <default name="monochromator-model" value="erik" />  <!-- "hole", "tube", or "erik"     -->
    <default name="environment-model"   value="none" />  <!-- "full" or "none"              -->

    <default name="detector.angular_diameter_of_field" value="2.000"/>

    <!-- Geometry variables -->

    <default name="detector.distance"    value="0.400"  />
    <default name="detector.motor_angle" value="90.000" />

    <bsdf type="diffuse" id="detector.outside-bsdf">
        <!-- NOTE: if we make this fully black, we don't see the scene anymore from inside the detector.
             TODO: figure out why this is the case. (Possibly a Mitsuba bug.) -->
        <spectrum name="reflectance" value="1e-20"/>
    </bsdf>

    <default name="monochromator.irradiance"  value="1"     />
    <default name="monochromator.diameter"    value="0.008" />
    <default name="monochromator.tube_length" value="0.040" />
    <default name="monochromator.distance"    value="0.600" />

    <bsdf type="diffuse" id="monochromator.outside-bsdf">
        <spectrum name="reflectance" value="1e-20"/>
    </bsdf>

    <default name="meris.high_motor_angle"   value="0"   />
    <default name="meris.middle_motor_angle" value="0"   />
    <default name="meris.low_motor_angle"    value="+45" />

    <!-- include stuff -->

    <include filename="colors.xml"/>
    <include filename="axes.xml"/>
    <include filename="environment-$environment-model.xml"/>

    <include filename="monochromator-$monochromator-model.xml"/>
    <include filename="sample-$sample-model.xml"/>
    <include filename="detector.xml"/>

    <!-- monochromator beam inhomogeneity mask -->
    <!--
    <shape type="rectangle">

        <bsdf type="mask">

            <texture name="opacity" type="bitmap">
                <string name="filename" value="testmask-negated.png"/>
                <string name="wrapMode" value="zero"/>
                <!- uscale == -1. uoffset=+1 ->
                <float name="uscale" value="+1"/>
                <float name="vscale" value="-1"/>
                <float name="uoffset" value="0"/>
                <float name="voffset" value="+1"/>
            </texture>

            <bsdf type="diffuse">
                <spectrum name="reflectance" value="0"/>
            </bsdf>

        </bsdf>

        <transform name="toWorld">
            <scale value="0.01"/>
            <translate z="0.55"/>
        </transform>
    </shape>
    -->

    <!--
    <sensor type="perspective" id="overview">

        <float name="fov" value="45"/>

        <transform name="toWorld">
            <lookat origin="3,0,1" target="0,0,0" up="0,1,0"/>
        </transform>

        <sampler type="independent">
            <integer name="sampleCount" value="8"/>
        </sampler>

        <film type="hdrfilm">
            <integer name="width"            value="960"     />
            <integer name="height"           value="600"     />
            <string  name="fileFormat"       value="openexr" />
            <string  name="pixelFormat"      value="rgb"     />
            <string  name="componentFormat"  value="float32" />
            <boolean name="attachLog"        value="true"    />
            <boolean name="banner"           value="false"   />
            <boolean name="highQualityEdges" value="false"   />
            <rfilter type="gaussian"/>
        </film>

    </sensor>
    -->

</scene>
